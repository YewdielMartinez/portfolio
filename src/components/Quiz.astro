---
// Quiz Component
---

<!-- Floating Quiz Button -->
<button 
  id="quiz-button" 
  class="fixed bottom-8 right-8 z-50 bg-[#F54927] text-white rounded-full p-4 shadow-2xl hover:scale-110 hover:rotate-12 transition-all duration-300 hover:shadow-[0_0_30px_rgba(245,73,39,0.6)]"
  aria-label="Open Quiz"
>
  <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
  </svg>
</button>

<!-- Quiz Modal -->
<div 
  id="quiz-modal" 
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 backdrop-blur-sm"
  style="animation: fade-in 0.3s ease-out;"
>
  <div 
    id="quiz-container"
    class="relative bg-white dark:bg-[#1a1a1a] rounded-3xl shadow-2xl max-w-2xl w-full mx-4 overflow-hidden"
    style="animation: slideIn 0.4s ease-out;"
  >
    <!-- Close Button -->
    <button 
      id="quiz-close" 
      class="absolute top-4 right-4 z-10 text-gray-800 dark:text-gray-400 hover:text-[#F54927] hover:rotate-90 transition-all duration-300 p-2"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>

    <!-- Quiz Header -->
    <div class="bg-[#F54927] p-8 text-white">
      <h2 id="quiz-title" class="text-3xl font-bold mb-2"></h2>
      <p id="quiz-description" class="text-white/90"></p>
      <div id="quiz-progress" class="mt-4 bg-white/20 rounded-full h-2 overflow-hidden hidden">
        <div id="quiz-progress-bar" class="bg-white h-full transition-all duration-300" style="width: 0%"></div>
      </div>
    </div>

    <!-- Quiz Content -->
    <div class="p-8">
      <!-- Start Screen -->
      <div id="quiz-start" class="text-center">
        <div class="mb-6 flex justify-center items-center min-h-[120px]">
          <div class="animate-bounce inline-block">
            <svg class="w-24 h-24 text-[#F54927]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
          </div>
        </div>
        <p id="quiz-ready-text" class="text-gray-600 dark:text-gray-400 mb-8 text-lg">
          Ready to test your knowledge?
        </p>
        <button 
          id="quiz-start-btn"
          class="px-8 py-4 bg-[#F54927] text-white rounded-xl font-semibold hover:scale-105 hover:shadow-xl hover:shadow-[#F54927]/30 transition-all duration-300"
        >
          Start Quiz
        </button>
      </div>

      <!-- Question Screen -->
      <div id="quiz-question" class="hidden">
        <div class="mb-6">
          <span class="text-sm font-semibold text-[#F54927]" id="question-number">Question 1 of 8</span>
          <h3 class="text-2xl font-bold text-gray-800 dark:text-white mt-2" id="question-text"></h3>
        </div>

        <div id="quiz-options" class="space-y-3">
          <!-- Options will be inserted here -->
        </div>

        <div id="quiz-feedback" class="hidden mt-6 p-4 rounded-xl">
          <p class="font-semibold mb-2" id="feedback-title"></p>
          <p class="text-sm" id="feedback-explanation"></p>
        </div>

        <button 
          id="quiz-next-btn"
          class="hidden mt-6 w-full px-6 py-3 bg-[#F54927] text-white rounded-xl font-semibold hover:scale-105 hover:shadow-xl transition-all duration-300"
        >
          Next Question
        </button>
      </div>

      <!-- Results Screen -->
      <div id="quiz-results" class="hidden text-center">
        <div id="results-icon" class="mb-6 flex justify-center">
          <!-- Icon will be inserted here -->
        </div>
        <h3 class="text-3xl font-bold text-gray-800 dark:text-white mb-4" id="results-message"></h3>
        <div class="text-6xl font-bold text-[#F54927] mb-8">
          <span id="results-score">0</span>
          <span class="text-2xl text-gray-400">/</span>
          <span id="results-total">8</span>
        </div>
        <button 
          id="quiz-retry-btn"
          class="px-8 py-4 bg-[#F54927] text-white rounded-xl font-semibold hover:scale-105 hover:shadow-xl transition-all duration-300"
        >
          Try Again
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  @keyframes fade-in {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes slideIn {
    from {
      transform: translateY(100px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .quiz-option {
    transition: all 0.3s ease;
  }

  .quiz-option:hover {
    transform: translateX(8px);
  }

  .quiz-option:hover .option-letter {
    color: white !important;
  }

  .quiz-option.correct {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    transform: scale(1.02);
  }

  .quiz-option.correct .option-letter {
    color: white !important;
  }

  .quiz-option.wrong {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    transform: scale(0.98);
  }

  .quiz-option.wrong .option-letter {
    color: white !important;
  }

  .quiz-option.disabled {
    opacity: 0.6;
    pointer-events: none;
  }
</style>

<script>
  // Import quiz data
  let quizData: any = null;
  let quizTranslations: any = null;
  let currentQuestion = 0;
  let score = 0;
  let answered = false;

  async function loadQuizData() {
    try {
      const module = await import('../data/quiz');
      const currentLang = (localStorage.getItem('language') || 'en') as 'en' | 'es';
      quizData = module.quiz[currentLang];
      quizTranslations = module.quizTranslations[currentLang];
      return quizTranslations;
    } catch (error) {
      console.error('Error loading quiz data:', error);
      return null;
    }
  }

  // DOM Elements
  const quizButton = document.getElementById('quiz-button');
  const quizModal = document.getElementById('quiz-modal');
  const quizClose = document.getElementById('quiz-close');
  const quizStart = document.getElementById('quiz-start');
  const quizQuestion = document.getElementById('quiz-question');
  const quizResults = document.getElementById('quiz-results');
  const quizStartBtn = document.getElementById('quiz-start-btn');
  const quizNextBtn = document.getElementById('quiz-next-btn');
  const quizRetryBtn = document.getElementById('quiz-retry-btn');

  // Open Modal
  quizButton?.addEventListener('click', async () => {
    const translations = await loadQuizData();
    if (!quizData || !translations) return;

    // Update UI text
    document.getElementById('quiz-title')!.textContent = quizData.title;
    document.getElementById('quiz-description')!.textContent = quizData.description;
    document.getElementById('quiz-start-btn')!.textContent = translations.startButton;
    
    const readyText = document.getElementById('quiz-ready-text');
    if (readyText) {
      readyText.textContent = translations.readyText || 'Ready to test your knowledge?';
    }

    quizModal?.classList.remove('hidden');
    quizModal?.classList.add('flex');
  });

  // Close Modal
  function closeModal() {
    quizModal?.classList.add('hidden');
    quizModal?.classList.remove('flex');
    resetQuiz();
  }

  quizClose?.addEventListener('click', closeModal);
  
  // Removed click outside to close - only close button works now

  // Start Quiz
  quizStartBtn?.addEventListener('click', async () => {
    quizStart?.classList.add('hidden');
    quizQuestion?.classList.remove('hidden');
    document.getElementById('quiz-progress')?.classList.remove('hidden');
    currentQuestion = 0;
    score = 0;
    showQuestion();
  });

  // Show Question
  async function showQuestion() {
    if (!quizData) return;

    answered = false;
    const question = quizData.questions[currentQuestion];
    
    // Update progress
    const progress = ((currentQuestion + 1) / quizData.questions.length) * 100;
    const progressBar = document.getElementById('quiz-progress-bar');
    if (progressBar) {
      progressBar.style.width = `${progress}%`;
    }

    // Update question
    const questionLabel = quizTranslations?.questionLabel || 'Question';
    const ofLabel = quizTranslations?.ofLabel || 'of';
    document.getElementById('question-number')!.textContent = 
      `${questionLabel} ${currentQuestion + 1} ${ofLabel} ${quizData.questions.length}`;
    document.getElementById('question-text')!.textContent = question.question;

    // Update options
    const optionsContainer = document.getElementById('quiz-options');
    if (optionsContainer) {
      optionsContainer.innerHTML = question.options.map((option: string, index: number) => `
        <button 
          class="quiz-option w-full text-left p-4 rounded-xl bg-gray-100 dark:bg-[#2a2a2a] text-gray-800 dark:text-white font-medium hover:bg-[#F54927] hover:text-white"
          data-index="${index}"
        >
          <span class="option-letter font-bold text-[#F54927] mr-3">${String.fromCharCode(65 + index)}.</span>
          ${option}
        </button>
      `).join('');

      // Add click handlers
      optionsContainer.querySelectorAll('.quiz-option').forEach(btn => {
        btn.addEventListener('click', handleAnswer);
      });
    }

    // Hide feedback and next button
    document.getElementById('quiz-feedback')?.classList.add('hidden');
    quizNextBtn?.classList.add('hidden');
  }

  // Handle Answer
  function handleAnswer(e: Event) {
    if (answered) return;
    answered = true;

    if (!quizTranslations) return;

    const button = e.currentTarget as HTMLButtonElement;
    const selectedIndex = parseInt(button.dataset.index || '0');
    const question = quizData.questions[currentQuestion];
    const isCorrect = selectedIndex === question.correctAnswer;

    if (isCorrect) {
      score++;
      button.classList.add('correct');
    } else {
      button.classList.add('wrong');
      // Highlight correct answer
      const correctBtn = document.querySelector(`[data-index="${question.correctAnswer}"]`);
      correctBtn?.classList.add('correct');
    }

    // Disable all options
    document.querySelectorAll('.quiz-option').forEach(btn => {
      btn.classList.add('disabled');
    });

    // Show feedback
    const feedback = document.getElementById('quiz-feedback');
    const feedbackTitle = document.getElementById('feedback-title');
    const feedbackExplanation = document.getElementById('feedback-explanation');
    
    if (feedback && feedbackTitle && feedbackExplanation) {
      feedback.classList.remove('hidden');
      feedbackTitle.textContent = isCorrect ? quizTranslations.correctAnswer : quizTranslations.wrongAnswer;
      feedbackExplanation.textContent = question.explanation || '';
      feedback.className = `mt-6 p-4 rounded-xl ${
        isCorrect 
          ? 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300' 
          : 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300'
      }`;
    }

    // Show next button
    if (quizNextBtn) {
      quizNextBtn.classList.remove('hidden');
      quizNextBtn.textContent = 
        currentQuestion < quizData.questions.length - 1 
          ? quizTranslations.nextButton 
          : quizTranslations.finishButton;
    }
  }

  // Next Question
  quizNextBtn?.addEventListener('click', () => {
    currentQuestion++;
    if (currentQuestion < quizData.questions.length) {
      showQuestion();
    } else {
      showResults();
    }
  });

  // Show Results
  function showResults() {
    if (!quizTranslations) return;

    quizQuestion?.classList.add('hidden');
    quizResults?.classList.remove('hidden');

    const percentage = (score / quizData.questions.length) * 100;
    let iconSvg = '';
    let iconColor = '#F54927';
    let message = quizTranslations.tryAgain;

    if (percentage === 100) {
      // Star icon
      iconSvg = `<div class="flex justify-center items-center min-h-[120px]"><div class="animate-bounce inline-block"><svg class="w-24 h-24 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
      </svg></div></div>`;
      message = quizTranslations.perfect;
    } else if (percentage >= 70) {
      // Trophy icon
      iconSvg = `<div class="flex justify-center items-center min-h-[120px]"><div class="animate-bounce inline-block"><svg class="w-24 h-24 text-[#F54927]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
      </svg></div></div>`;
      message = quizTranslations.great;
    } else if (percentage >= 50) {
      // Thumbs up icon
      iconSvg = `<div class="flex justify-center items-center min-h-[120px]"><div class="animate-bounce inline-block"><svg class="w-24 h-24 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"></path>
      </svg></div></div>`;
      message = quizTranslations.good;
    } else {
      // Target icon
      iconSvg = `<div class="flex justify-center items-center min-h-[120px]"><svg class="w-24 h-24 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
      </svg></div>`;
    }

    const resultsIcon = document.getElementById('results-icon');
    if (resultsIcon) {
      resultsIcon.innerHTML = iconSvg;
    }
    
    document.getElementById('results-message')!.textContent = message;
    document.getElementById('results-score')!.textContent = score.toString();
    document.getElementById('results-total')!.textContent = quizData.questions.length.toString();
    document.getElementById('quiz-retry-btn')!.textContent = quizTranslations.retryButton;
  }

  // Retry Quiz
  quizRetryBtn?.addEventListener('click', () => {
    resetQuiz();
    quizResults?.classList.add('hidden');
    quizStart?.classList.remove('hidden');
    document.getElementById('quiz-progress')?.classList.add('hidden');
  });

  // Reset Quiz
  function resetQuiz() {
    currentQuestion = 0;
    score = 0;
    answered = false;
  }

  // Language change handler
  window.addEventListener('languageChange', async () => {
    const translations = await loadQuizData();
    if (!quizData || !translations) return;

    // Only update if modal is open
    if (!quizModal?.classList.contains('hidden')) {
      document.getElementById('quiz-title')!.textContent = quizData.title;
      document.getElementById('quiz-description')!.textContent = quizData.description;
      document.getElementById('quiz-start-btn')!.textContent = translations.startButton;
      
      const readyText = document.getElementById('quiz-ready-text');
      if (readyText && quizStart && !quizStart.classList.contains('hidden')) {
        readyText.textContent = translations.readyText || 'Ready to test your knowledge?';
      }
    }
  });
</script>
